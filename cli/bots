#!/usr/bin/env node

const axios = require('axios');
const fs = require('fs');
const path = require('path');
const os = require('os');

const CONFIG_DIR = path.join(os.homedir(), '.config', 'bot-manager');
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');
const API_BASE = process.env.BOT_MANAGER_API || 'https://bots.notjackal.eu/api';

// Naƒç√≠st konfiguraci (token)
function loadConfig() {
  if (!fs.existsSync(CONFIG_FILE)) {
    return null;
  }
  return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
}

// Ulo≈æit konfiguraci
function saveConfig(config) {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true });
  }
  fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2));
}

// API client
async function apiRequest(method, endpoint, data = null) {
  const config = loadConfig();

  if (!config || !config.token) {
    console.error('‚ùå Nejsi p≈ôihl√°≈°en. Spus≈•: bots login');
    process.exit(1);
  }

  try {
    const requestConfig = {
      method,
      url: `${API_BASE}${endpoint}`,
      headers: {
        'Authorization': `Bearer ${config.token}`
      }
    };

    // P≈ôidat data a Content-Type pouze pro POST/PUT/PATCH
    if (data && ['POST', 'PUT', 'PATCH'].includes(method.toUpperCase())) {
      requestConfig.headers['Content-Type'] = 'application/json';
      requestConfig.data = data;
    }

    const response = await axios(requestConfig);

    return response.data;
  } catch (error) {
    if (error.response?.status === 401) {
      console.error('‚ùå Token vypr≈°el. P≈ôihla≈° se znovu: bots login');
      process.exit(1);
    }
    throw error;
  }
}

// Commands

async function login() {
  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const question = (q) => new Promise(resolve => readline.question(q, resolve));

  const username = await question('Username: ');
  const password = await question('Password: ');
  readline.close();

  try {
    const response = await axios.post(`${API_BASE}/auth/login`, { username, password });

    if (response.data.success) {
      saveConfig({ token: response.data.token, user: response.data.user });
      console.log('‚úÖ P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©');
      console.log(`üë§ U≈æivatel: ${response.data.user.username}`);
    }
  } catch (error) {
    console.error('‚ùå Chyba p≈ôi p≈ôihl√°≈°en√≠:', error.response?.data?.message || error.message);
    process.exit(1);
  }
}

async function list() {
  try {
    const data = await apiRequest('GET', '/bots');
    const bots = data.bots;

    if (bots.length === 0) {
      console.log('üì≠ ≈Ω√°dn√© boty');
      return;
    }

    console.log('\nü§ñ Seznam bot≈Ø:\n');
    bots.forEach(bot => {
      const statusEmoji = bot.status === 'online' ? 'üü¢' : 'üî¥';
      console.log(`${statusEmoji} ${bot.name}`);
      console.log(`   ID: ${bot.id}`);
      console.log(`   Typ: ${bot.type === 'nodejs' ? 'Node.js' : 'Python'}`);
      console.log(`   Status: ${bot.status}`);
      if (bot.status === 'online') {
        console.log(`   CPU: ${bot.cpu?.toFixed(1)}% | RAM: ${(bot.memory / 1024 / 1024).toFixed(0)} MB`);
      }
      console.log('');
    });
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function add() {
  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const question = (q) => new Promise(resolve => readline.question(q, resolve));

  console.log('\nü§ñ P≈ôid√°n√≠ nov√©ho bota\n');

  const name = await question('N√°zev: ');
  const type = await question('Typ (nodejs/python): ');
  const script_path = await question('Cesta ke scriptu: ');
  const loadEnv = await question('Naƒç√≠st .env? (y/n): ');

  let env_vars = '{}';

  if (loadEnv.toLowerCase() === 'y') {
    try {
      const envData = await apiRequest('POST', '/parse-env', { script_path });
      if (envData.success && Object.keys(envData.env_vars).length > 0) {
        env_vars = JSON.stringify(envData.env_vars);
        console.log(`‚úÖ ${envData.message}`);
      } else {
        console.log('‚ÑπÔ∏è  .env nenalezen, pokraƒçuji bez ENV promƒõnn√Ωch');
      }
    } catch (error) {
      console.log('‚ö†Ô∏è  Chyba p≈ôi naƒç√≠t√°n√≠ .env, pokraƒçuji bez ENV promƒõnn√Ωch');
    }
  }

  readline.close();

  try {
    const data = await apiRequest('POST', '/bots', {
      name,
      type: type === 'python' ? 'python' : 'nodejs',
      script_path,
      env_vars
    });

    console.log(`\n‚úÖ Bot "${name}" p≈ôid√°n (ID: ${data.bot.id})`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function remove(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots remove <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    await apiRequest('DELETE', `/bots/${bot.id}`);
    console.log(`‚úÖ Bot "${bot.name}" odstranƒõn`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function start(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots start <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    await apiRequest('POST', `/bots/${bot.id}/start`);
    console.log(`‚úÖ Bot "${bot.name}" spu≈°tƒõn`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function stop(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots stop <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    await apiRequest('POST', `/bots/${bot.id}/stop`);
    console.log(`‚úÖ Bot "${bot.name}" zastaven`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function restart(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots restart <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    await apiRequest('POST', `/bots/${bot.id}/restart`);
    console.log(`‚úÖ Bot "${bot.name}" restartov√°n`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function logs(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots logs <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    const logsData = await apiRequest('GET', `/bots/${bot.id}/logs?lines=50`);

    console.log(`\nüìã Logy pro "${bot.name}":\n`);

    if (logsData.logs.stdout) {
      console.log('--- STDOUT ---');
      console.log(logsData.logs.stdout);
    }

    if (logsData.logs.stderr) {
      console.log('\n--- STDERR ---');
      console.log(logsData.logs.stderr);
    }

    if (!logsData.logs.stdout && !logsData.logs.stderr) {
      console.log('Zat√≠m ≈æ√°dn√© logy');
    }
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

function help() {
  console.log(`
ü§ñ Bot Manager CLI

Pou≈æit√≠:
  bots <command> [options]

Commands:
  login              P≈ôihl√°sit se k Bot Manageru
  list               Zobrazit seznam v≈°ech bot≈Ø
  add                P≈ôidat nov√©ho bota (interaktivn√≠)
  remove <name|id>   Odstranit bota
  start <name|id>    Spustit bota
  stop <name|id>     Zastavit bota
  restart <name|id>  Restartovat bota
  logs <name|id>     Zobrazit logy bota
  help               Zobrazit n√°povƒõdu

P≈ô√≠klady:
  bots login
  bots list
  bots add
  bots start music-bot
  bots stop 1
  bots logs music-bot
  bots remove music-bot
`);
}

// Main
const command = process.argv[2];
const arg = process.argv[3];

(async () => {
  switch (command) {
    case 'login':
      await login();
      break;
    case 'list':
      await list();
      break;
    case 'add':
      await add();
      break;
    case 'remove':
      await remove(arg);
      break;
    case 'start':
      await start(arg);
      break;
    case 'stop':
      await stop(arg);
      break;
    case 'restart':
      await restart(arg);
      break;
    case 'logs':
      await logs(arg);
      break;
    case 'help':
    case undefined:
      help();
      break;
    default:
      console.error(`‚ùå Nezn√°m√Ω p≈ô√≠kaz: ${command}`);
      help();
      process.exit(1);
  }
})();
