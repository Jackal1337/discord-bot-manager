#!/usr/bin/env node

const axios = require('axios');
const fs = require('fs');
const path = require('path');
const os = require('os');
const chalk = require('chalk');
const Table = require('cli-table3');
const ora = require('ora');

const CONFIG_DIR = path.join(os.homedir(), '.config', 'bot-manager');
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');
const API_BASE = process.env.BOT_MANAGER_API || 'https://bots.notjackal.eu/api';

// Naƒç√≠st konfiguraci (token)
function loadConfig() {
  if (!fs.existsSync(CONFIG_FILE)) {
    return null;
  }
  return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
}

// Ulo≈æit konfiguraci
function saveConfig(config) {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true });
  }
  fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2));
}

// API client
async function apiRequest(method, endpoint, data = null) {
  const config = loadConfig();

  if (!config || !config.token) {
    console.error('‚ùå Nejsi p≈ôihl√°≈°en. Spus≈•: bots login');
    process.exit(1);
  }

  try {
    const requestConfig = {
      method,
      url: `${API_BASE}${endpoint}`,
      headers: {
        'Authorization': `Bearer ${config.token}`
      }
    };

    // P≈ôidat data a Content-Type pouze pro POST/PUT/PATCH
    if (data && ['POST', 'PUT', 'PATCH'].includes(method.toUpperCase())) {
      requestConfig.headers['Content-Type'] = 'application/json';
      requestConfig.data = data;
    }

    const response = await axios(requestConfig);

    return response.data;
  } catch (error) {
    if (error.response?.status === 401) {
      console.error('‚ùå Token vypr≈°el. P≈ôihla≈° se znovu: bots login');
      process.exit(1);
    }
    throw error;
  }
}

// Commands

async function login() {
  console.log(chalk.bold.cyan('\n  BOT MANAGER - P≈ôihl√°≈°en√≠\n'));

  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const question = (q) => new Promise(resolve => readline.question(chalk.gray('  ' + q), resolve));

  const username = await question('Username: ');
  const password = await question('Password: ');
  readline.close();

  const spinner = ora('P≈ôihla≈°uji...').start();

  try {
    const response = await axios.post(`${API_BASE}/auth/login`, { username, password });

    if (response.data.success) {
      saveConfig({ token: response.data.token, user: response.data.user });
      spinner.succeed(chalk.green('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©'));
      console.log(chalk.gray(`  U≈æivatel: ${chalk.white.bold(response.data.user.username)}\n`));
    }
  } catch (error) {
    spinner.fail(chalk.red('Chyba p≈ôi p≈ôihl√°≈°en√≠'));
    console.error(chalk.red('  ' + (error.response?.data?.message || error.message)) + '\n');
    process.exit(1);
  }
}

async function list() {
  const spinner = ora('Naƒç√≠t√°m boty...').start();

  try {
    const data = await apiRequest('GET', '/bots');
    const bots = data.bots;

    spinner.stop();
    spinner.clear();

    if (bots.length === 0) {
      console.log(chalk.yellow('\n  Zat√≠m nem√°≈° ≈æ√°dn√© boty\n'));
      return;
    }

    console.log(chalk.bold.cyan('\n  BOT MANAGER\n'));

    const table = new Table({
      head: [
        chalk.gray('ID'),
        chalk.gray('N√°zev'),
        chalk.gray('Typ'),
        chalk.gray('Status'),
        chalk.gray('CPU'),
        chalk.gray('Memory')
      ],
      style: {
        head: [],
        border: ['gray']
      }
    });

    bots.forEach(bot => {
      const type = bot.type === 'nodejs' ? 'Node.js' : 'Python';

      let status, statusColor;
      if (bot.status === 'online') {
        status = '‚óè ONLINE';
        statusColor = chalk.green;
      } else if (bot.status === 'stopping') {
        status = '‚óè STOPPING';
        statusColor = chalk.yellow;
      } else if (bot.status === 'errored') {
        status = '‚óè ERROR';
        statusColor = chalk.red;
      } else {
        status = '‚óè OFFLINE';
        statusColor = chalk.gray;
      }

      const cpu = bot.status === 'online' ? `${bot.cpu?.toFixed(1)}%` : '-';
      const memory = bot.status === 'online' ? `${(bot.memory / 1024 / 1024).toFixed(0)} MB` : '-';

      table.push([
        chalk.white(bot.id),
        chalk.white.bold(bot.name),
        chalk.cyan(type),
        statusColor(status),
        bot.status === 'online' ? chalk.blue(cpu) : chalk.gray(cpu),
        bot.status === 'online' ? chalk.magenta(memory) : chalk.gray(memory)
      ]);
    });

    console.log(table.toString());

    const online = bots.filter(b => b.status === 'online').length;
    const offline = bots.length - online;

    console.log(chalk.gray(`\n  ${bots.length} bot≈Ø celkem  ‚Ä¢  ${chalk.green(online + ' online')}  ‚Ä¢  ${chalk.gray(offline + ' offline')}\n`));
  } catch (error) {
    spinner.fail(chalk.red('Chyba p≈ôi naƒç√≠t√°n√≠'));
    console.error(chalk.red('  ' + (error.response?.data?.message || error.message)));
  }
}

async function add() {
  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const question = (q) => new Promise(resolve => readline.question(q, resolve));

  console.log('\nü§ñ P≈ôid√°n√≠ nov√©ho bota\n');

  const name = await question('N√°zev: ');
  const type = await question('Typ (nodejs/python): ');
  const script_path = await question('Cesta ke scriptu: ');
  const loadEnv = await question('Naƒç√≠st .env? (y/n): ');

  let env_vars = '{}';

  if (loadEnv.toLowerCase() === 'y') {
    try {
      const envData = await apiRequest('POST', '/parse-env', { script_path });
      if (envData.success && Object.keys(envData.env_vars).length > 0) {
        env_vars = JSON.stringify(envData.env_vars);
        console.log(`‚úÖ ${envData.message}`);
      } else {
        console.log('‚ÑπÔ∏è  .env nenalezen, pokraƒçuji bez ENV promƒõnn√Ωch');
      }
    } catch (error) {
      console.log('‚ö†Ô∏è  Chyba p≈ôi naƒç√≠t√°n√≠ .env, pokraƒçuji bez ENV promƒõnn√Ωch');
    }
  }

  readline.close();

  try {
    const data = await apiRequest('POST', '/bots', {
      name,
      type: type === 'python' ? 'python' : 'nodejs',
      script_path,
      env_vars
    });

    console.log(`\n‚úÖ Bot "${name}" p≈ôid√°n (ID: ${data.bot.id})`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function remove(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots remove <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    await apiRequest('DELETE', `/bots/${bot.id}`);
    console.log(`‚úÖ Bot "${bot.name}" odstranƒõn`);
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

async function start(nameOrId) {
  if (!nameOrId) {
    console.log(chalk.red('\n  Pou≈æit√≠: bots start <name|id>\n'));
    process.exit(1);
  }

  const spinner = ora('Hled√°m bota...').start();

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      spinner.fail(chalk.red(`Bot "${nameOrId}" nenalezen`));
      console.log('');
      process.exit(1);
    }

    spinner.text = `Spou≈°t√≠m ${chalk.bold(bot.name)}...`;
    await apiRequest('POST', `/bots/${bot.id}/start`);
    spinner.succeed(chalk.green(`Bot ${chalk.bold(bot.name)} spu≈°tƒõn`));
    console.log('');
  } catch (error) {
    spinner.fail(chalk.red('Chyba'));
    console.error(chalk.red('  ' + (error.response?.data?.message || error.message)) + '\n');
  }
}

async function stop(nameOrId) {
  if (!nameOrId) {
    console.log(chalk.red('\n  Pou≈æit√≠: bots stop <name|id>\n'));
    process.exit(1);
  }

  const spinner = ora('Hled√°m bota...').start();

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      spinner.fail(chalk.red(`Bot "${nameOrId}" nenalezen`));
      console.log('');
      process.exit(1);
    }

    spinner.text = `Zastavuji ${chalk.bold(bot.name)}...`;
    await apiRequest('POST', `/bots/${bot.id}/stop`);
    spinner.succeed(chalk.yellow(`Bot ${chalk.bold(bot.name)} zastaven`));
    console.log('');
  } catch (error) {
    spinner.fail(chalk.red('Chyba'));
    console.error(chalk.red('  ' + (error.response?.data?.message || error.message)) + '\n');
  }
}

async function restart(nameOrId) {
  if (!nameOrId) {
    console.log(chalk.red('\n  Pou≈æit√≠: bots restart <name|id>\n'));
    process.exit(1);
  }

  const spinner = ora('Hled√°m bota...').start();

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      spinner.fail(chalk.red(`Bot "${nameOrId}" nenalezen`));
      console.log('');
      process.exit(1);
    }

    spinner.text = `Restartuji ${chalk.bold(bot.name)}...`;
    await apiRequest('POST', `/bots/${bot.id}/restart`);
    spinner.succeed(chalk.cyan(`Bot ${chalk.bold(bot.name)} restartov√°n`));
    console.log('');
  } catch (error) {
    spinner.fail(chalk.red('Chyba'));
    console.error(chalk.red('  ' + (error.response?.data?.message || error.message)) + '\n');
  }
}

async function logs(nameOrId) {
  if (!nameOrId) {
    console.error('‚ùå Pou≈æit√≠: bots logs <name|id>');
    process.exit(1);
  }

  try {
    const data = await apiRequest('GET', '/bots');
    const bot = data.bots.find(b => b.name === nameOrId || b.id == nameOrId);

    if (!bot) {
      console.error(`‚ùå Bot "${nameOrId}" nenalezen`);
      process.exit(1);
    }

    const logsData = await apiRequest('GET', `/bots/${bot.id}/logs?lines=50`);

    console.log(`\nüìã Logy pro "${bot.name}":\n`);

    if (logsData.logs.stdout) {
      console.log('--- STDOUT ---');
      console.log(logsData.logs.stdout);
    }

    if (logsData.logs.stderr) {
      console.log('\n--- STDERR ---');
      console.log(logsData.logs.stderr);
    }

    if (!logsData.logs.stdout && !logsData.logs.stderr) {
      console.log('Zat√≠m ≈æ√°dn√© logy');
    }
  } catch (error) {
    console.error('‚ùå Chyba:', error.response?.data?.message || error.message);
  }
}

function help() {
  console.log(chalk.bold.cyan('\n  BOT MANAGER CLI\n'));
  console.log(chalk.gray('  Pou≈æit√≠:'));
  console.log(chalk.white('    bots <command> [options]\n'));

  console.log(chalk.gray('  Commands:'));
  console.log(chalk.cyan('    login            ') + chalk.gray('P≈ôihl√°sit se k Bot Manageru'));
  console.log(chalk.cyan('    list             ') + chalk.gray('Zobrazit seznam v≈°ech bot≈Ø'));
  console.log(chalk.cyan('    add              ') + chalk.gray('P≈ôidat nov√©ho bota (interaktivn√≠)'));
  console.log(chalk.cyan('    remove ') + chalk.yellow('<name|id>') + chalk.gray('  Odstranit bota'));
  console.log(chalk.cyan('    start  ') + chalk.yellow('<name|id>') + chalk.gray('  Spustit bota'));
  console.log(chalk.cyan('    stop   ') + chalk.yellow('<name|id>') + chalk.gray('  Zastavit bota'));
  console.log(chalk.cyan('    restart') + chalk.yellow(' <name|id>') + chalk.gray('  Restartovat bota'));
  console.log(chalk.cyan('    logs   ') + chalk.yellow('<name|id>') + chalk.gray('  Zobrazit logy bota'));
  console.log(chalk.cyan('    help             ') + chalk.gray('Zobrazit n√°povƒõdu\n'));

  console.log(chalk.gray('  P≈ô√≠klady:'));
  console.log(chalk.white('    bots login'));
  console.log(chalk.white('    bots list'));
  console.log(chalk.white('    bots add'));
  console.log(chalk.white('    bots start music-bot'));
  console.log(chalk.white('    bots stop 1'));
  console.log(chalk.white('    bots logs music-bot'));
  console.log(chalk.white('    bots remove music-bot\n'));
}

// Main
const command = process.argv[2];
const arg = process.argv[3];

(async () => {
  switch (command) {
    case 'login':
      await login();
      break;
    case 'list':
      await list();
      break;
    case 'add':
      await add();
      break;
    case 'remove':
      await remove(arg);
      break;
    case 'start':
      await start(arg);
      break;
    case 'stop':
      await stop(arg);
      break;
    case 'restart':
      await restart(arg);
      break;
    case 'logs':
      await logs(arg);
      break;
    case 'help':
    case undefined:
      help();
      break;
    default:
      console.error(`‚ùå Nezn√°m√Ω p≈ô√≠kaz: ${command}`);
      help();
      process.exit(1);
  }
})();
